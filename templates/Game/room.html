{% extends 'base.html' %}

{% block title %}FunBoard{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Чат кімнати {{ room.code }}</title>
    <style>
        /* --- Стилі для таблиці гри --- */
        .game_board {
            border-collapse: collapse;
            margin: 20px auto;
        }
        .game_board td {
            width: 50px;
            height: 50px;
            border: 1px solid #333;
            text-align: center;
            vertical-align: middle;
            background-color: #f0f0f0;
            cursor: pointer;
        }

        /* --- Стилі для чату --- */
        #chat-box {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: scroll;
            padding: 5px;
            background-color: #fafafa;
            margin-bottom: 10px;
        }

        #message-form textarea {
            width: 100%;
            height: 50px;
            margin-bottom: 5px;
        }
        #message-form button {
            padding: 5px 10px;
        }

        /* --- Стилі для списку гравців --- */
        #players-list {
            list-style: none;
            padding-left: 0;
        }
        #players-list li {
            padding: 2px 0;
        }
    </style>
</head>

<h1>Кімната {{ room.code }}</h1>

<h3>Гравці:</h3>
<ul id="players-list">
    {% for player in players %}
        <li>{{ player.name }}</li>
    {% endfor %}
</ul>

<h3>Чат:</h3>
<div id="chat-box">
    {% for message in messages %}
        <div class="message">
            <strong>{{ message.player.name }}</strong>: {{ message.content }}
            <div style="font-size:0.8em; color:gray;">
                {{ message.timestamp|date:"H:i:s" }}
            </div>
        </div>
    {% endfor %}
</div>

<form method="POST" id="message-form">
    {% csrf_token %}
    <textarea name="content" id="messageInput" placeholder="Введіть повідомлення..." required></textarea>
    <button type="submit">Надіслати</button>
</form>
<a href="{% url 'game_board' room.code player_uuid %}" class="btn">Розпочати гру</a>



<script>
const roomCode = "{{ room.code }}";
const chatBox = document.getElementById('chat-box');
const playersList = document.getElementById('players-list');
const form = document.getElementById('message-form');
const textarea = document.getElementById('messageInput');

// Функція для оновлення чату і гравців
function updateRoom() {
    // Оновлення гравців
    fetch(window.location.href + '?ajax=players')
        .then(res => res.json())
        .then(data => {
            playersList.innerHTML = data.players.map(p => `<li>${p.name}</li>`).join('');
        });

    // Оновлення чату
    fetch(window.location.href + '?ajax=messages')
        .then(res => res.json())
        .then(data => {
            chatBox.innerHTML = data.messages.map(m =>
                `<div class="message">
                    <strong>${m.player}</strong>: ${m.content}
                    <div style="font-size:0.8em; color:gray;">${m.timestamp}</div>
                </div>`
            ).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

// Оновлення кожні 3 секунди
setInterval(updateRoom, 3000);

// Відправка повідомлень через AJAX
form.addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData(form);

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'ok') {
            textarea.value = '';
            updateRoom();
        }
    });
});

</script>
{% endblock %}
