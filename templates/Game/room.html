{% extends 'base.html' %}

{% block title %}FunBoard{% endblock %}
{% load custom_filters %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Чат кімнати {{ room.code }}</title>
</head>
<h1>Кімната {{ room.code }}</h1>
<h3>Гравці:</h3>
<ul id="players-list">
    {% for player in players %}
        <li>{{ player.name }}</li>
    {% endfor %}
</ul>

<h3>Чат:</h3>
<div id="chat-box">
    {% for message in messages %}
        <div class="message">
            <strong>{{ message.player.name }}</strong>: {{ message.content }}
            <div style="font-size:0.8em; color:gray;">
                {{ message.timestamp|date:"H:i:s" }}
            </div>
        </div>
    {% endfor %}
</div>

<form method="POST" id="message-form">
    {% csrf_token %}
<textarea name="content" id="messageInput" placeholder="Введіть повідомлення..." required></textarea>
<button type="submit">Надіслати</button>
</form>


<script>
const roomCode = "{{ room.code }}";
const chatBox = document.getElementById('chat-box');
const playersList = document.getElementById('players-list');
const form = document.getElementById('message-form');
const textarea = document.getElementById('messageInput');

// Функція для оновлення чату і гравців
function updateRoom() {
    // Оновлення гравців
    fetch(window.location.href + '?ajax=players')
        .then(res => res.json())
        .then(data => {
            playersList.innerHTML = data.players.map(p => `<li>${p.name}</li>`).join('');
        });

    // Оновлення чату
    fetch(window.location.href + '?ajax=messages')
        .then(res => res.json())
        .then(data => {
            chatBox.innerHTML = data.messages.map(m =>
                `<div class="message">
                    <strong>${m.player}</strong>: ${m.content}
                    <div style="font-size:0.8em; color:gray;">${m.timestamp}</div>
                </div>`
            ).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

// Оновлення кожні 3 секунди
setInterval(updateRoom, 3000);

// Відправка повідомлень через AJAX
form.addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData(form);

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest' // щоб сервер знав, що це AJAX
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'ok') {
            textarea.value = '';  // <- очищення textarea
            updateRoom();         // <- оновлення чату та гравців
        }
    });
});
</script>



{% endblock %}