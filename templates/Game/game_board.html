{% extends 'base.html' %}

{% block title %}FunBoard{% endblock %}
{% load static %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç –∫—ñ–º–Ω–∞—Ç–∏ {{ room.code }}</title>
    <style>
        /* --- –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –≥—Ä–∏ --- */
        .game_board {
            border-collapse: collapse;
            margin: 20px auto;
        }
        .game_board td {
            width: 50px;
            height: 50px;
            border: 1px solid #333;
            text-align: center;
            vertical-align: middle;
            background-color: #f0f0f0;
            cursor: pointer;
        }
.game_board {
    width: 90vw;
    height: 90vh;
    border: 3px dashed #333;  /* –∫–æ–Ω—Ç—É—Ä –ø–æ–ª—è */
    position: relative;        /* —â–æ–± –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ –ø–æ–∑–∏—Ü—ñ—é–≤–∞—Ç–∏ */
    margin: 20px auto;
    background-color: #f0f0f0;
}

/* –ö–≤–∞–¥—Ä–∞—Ç–∏–∫–∏, —è–∫—ñ –ø–æ–∑–Ω–∞—á–∞—é—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤ */
.start {
    width: 30px;
    height: 30px;
    background-color: white;
    border: 2px solid black;
    position: absolute;        /* –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–∞–≤–∏—Ç–∏ —Ö–∞–æ—Ç–∏—á–Ω–æ */
    border-radius: 5px;        /* –∫–≤–∞–¥—Ä–∞—Ç –∑ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—è–º –∫—É—Ç—ñ–≤ */
}
.nm_ps {
    width: 30px;
    height: 30px;
    background-color: white;
    border: 2px solid black;
    position: absolute;        /* –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–∞–≤–∏—Ç–∏ —Ö–∞–æ—Ç–∏—á–Ω–æ */
    border-radius: 5px;        /* –∫–≤–∞–¥—Ä–∞—Ç –∑ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—è–º –∫—É—Ç—ñ–≤ */
}

/* --- –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –≥—Ä–∏ --- */
        .game_board {
            border-collapse: collapse;
            margin: 20px auto;
        }
        .game_board td {
            width: 50px;
            height: 50px;
            border: 1px solid #333;
            text-align: center;
            vertical-align: middle;
            background-color: #f0f0f0;
            cursor: pointer;
        }

        /* --- –°—Ç–∏–ª—ñ –¥–ª—è —á–∞—Ç—É --- */
        #chat-box {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: scroll;
            padding: 5px;
            background-color: #fafafa;
            margin-bottom: 10px;
        }

        #message-form textarea {
            width: 100%;
            height: 50px;
            margin-bottom: 5px;
        }
        #message-form button {
            padding: 5px 10px;
        }

        /* --- –°—Ç–∏–ª—ñ –¥–ª—è —Å–ø–∏—Å–∫—É –≥—Ä–∞–≤—Ü—ñ–≤ --- */
        #players-list {
            list-style: none;
            padding-left: 0;
        }
        #players-list li {
            padding: 2px 0;
        }
#board {
  position: relative;
  width: 600px;
  height: 400px;
  margin: 100px auto;
  background: url("{% static 'images/map.png' %}") no-repeat center center;
  background-size: cover;
  border: 2px solid #333;
  border-radius: 10px;
}

#player {
  position: absolute;
  width: 40px;
  height: 40px;
  background: red;
  border-radius: 50%;
  transition: all 0.8s ease; /* –ø–ª–∞–≤–Ω–∏–π —Ä—É—Ö */
  left: 0;
  top: 0;
}

#dice-wrapper {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 999999;
}

#dice {
  width: 80px;
  height: 80px;
  margin-bottom: 10px;
  transition: transform 0.3s ease;
}

#rollButton {
  background: #ffcc00;
  color: #222;
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

#rollButton:hover {
  background: #ffaa00;
  transform: scale(1.05);
}


    </style>
</head>
<div class="game_board">
    <div class="start" style="top: 430px; left: 20px;"></div>

    <div class="nm_ps" style="top: 430px; left: 20px;"><a>1</a></div>
    <div class="nm_ps" style="top: 430px; left: 120px;"><a>2</a></div>
    <div class="nm_ps" style="top: 430px; left: 220px;"><a>3</a></div>
    <div class="nm_ps" style="top: 430px; left: 320px;"><a>4</a></div>
    <div class="nm_ps" style="top: 430px; left: 420px;"><a>5</a></div>
    <div class="nm_ps" style="top: 430px; left: 520px;"><a>6</a></div>
    <div class="nm_ps" style="top: 430px; left: 620px;"><a>7</a></div>
    <div class="nm_ps" style="top: 430px; left: 720px;"><a>8</a></div>
    <div class="nm_ps" style="top: 430px; left: 820px;"><a>9</a></div>

    <div class="nm_ps" style="top: 330px; left: 820px;"><a>10</a></div>

    <div class="nm_ps" style="top: 230px; left: 820px;"><a>11</a></div>
    <div class="nm_ps" style="top: 230px; left: 720px;"><a>12</a></div>
    <div class="nm_ps" style="top: 230px; left: 620px;"><a>13</a></div>
    <div class="nm_ps" style="top: 230px; left: 520px;"><a>14</a></div>
    <div class="nm_ps" style="top: 230px; left: 420px;"><a>15</a></div>
    <div class="nm_ps" style="top: 230px; left: 320px;"><a>16</a></div>
    <div class="nm_ps" style="top: 230px; left: 220px;"><a>17</a></div>
    <div class="nm_ps" style="top: 230px; left: 120px;"><a>18</a></div>
    <div class="nm_ps" style="top: 230px; left: 20px;"><a>19</a></div>

    <div class="nm_ps" style="top: 130px; left: 20px;"><a>20</a></div>

    <div class="nm_ps" style="top: 30px; left: 20px;"><a>21</a></div>
    <div class="nm_ps" style="top: 30px; left: 120px;"><a>22</a></div>
    <div class="nm_ps" style="top: 30px; left: 220px;"><a>23</a></div>
    <div class="nm_ps" style="top: 30px; left: 320px;"><a>24</a></div>
    <div class="nm_ps" style="top: 30px; left: 420px;"><a>25</a></div>
    <div class="nm_ps" style="top: 30px; left: 520px;"><a>26</a></div>
    <div class="nm_ps" style="top: 30px; left: 620px;"><a>27</a></div>
    <div class="nm_ps" style="top: 30px; left: 720px;"><a>28</a></div>
    <div class="nm_ps" style="top: 30px; left: 820px;"><a>29</a></div>

    <div class="nm_ps" style="top: 30px; left: 920px;"><a>30</a></div>

    {% for p in players %}
        <div id="player-{{ p.uuid }}" class="player" style="position:absolute; left:0; top:0;">
            {{ p.name }}
        </div>
    {% endfor %}
</div>


<div id="dice-wrapper">
  <img id="dice" src="{% static 'images/dice1.png' %}" alt="Dice">
  <button id="rollButton">üé≤</button>
</div>



<h1>–ö—ñ–º–Ω–∞—Ç–∞ {{ room.code }}</h1>

<h3>–ì—Ä–∞–≤—Ü—ñ:</h3>
<ul id="players-list">
    {% for player in players %}
        <li>{{ player.name }}</li>
    {% endfor %}
</ul>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É Django ---
    // –£–í–ê–ì–ê: –ó–∞–º—ñ–Ω—ñ—Ç—å "..." –Ω–∞ –≤–∞—à—ñ –∑–º—ñ–Ω–Ω—ñ, —è–∫—ñ –ø—Ä–∏—Ö–æ–¥—è—Ç—å –∑ –±–µ–∫–µ–Ω–¥—É
    const roomCode = "{{ room.code }}";
    const currentPlayerUuid = "{{ player.uuid }}"; // ID —Ñ—ñ—à–∫–∏, —è–∫–æ—é –∫–µ—Ä—É—î —Ü–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–ª—è Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- 2. –û—Ç—Ä–∏–º–∞–Ω–Ω—è DOM-–µ–ª–µ–º–µ–Ω—Ç—ñ–≤ ---
    const dice = document.getElementById("dice");
    const rollButton = document.getElementById("rollButton");
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID —Ñ—ñ—à–∫–∏ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è
    const playerToken = document.getElementById(`player-${currentPlayerUuid}`);
    const chatBox = document.getElementById('chat-box');
    const playersList = document.getElementById('players-list');
    const form = document.getElementById('message-form');
    // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: –æ—Ç—Ä–∏–º–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç –∑–∞ ID
    const textarea = document.getElementById('messageInput');

    rollButton.addEventListener('click', rollDice);

    // –Ø–∫—â–æ –∫—Ä–∏—Ç–∏—á–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ, –ø—Ä–∏–ø–∏–Ω—è—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
    if (!dice || !rollButton ) {
         console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –æ–¥–∏–Ω –∞–±–æ –∫—ñ–ª—å–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ DOM (–∫—É–±–∏–∫, –∫–Ω–æ–ø–∫–∞, —Ñ—ñ—à–∫–∞ –≥—Ä–∞–≤—Ü—è, —Ñ–æ—Ä–º–∞ —á–∞—Ç—É –∞–±–æ textarea).");
         return;
    }

    // --- 3. –ü–æ–∑–∏—Ü—ñ—ó –Ω–∞ –¥–æ—à—Ü—ñ ---
    // –ú–∞—Å–∏–≤ –ø–æ–∑–∏—Ü—ñ–π —Ñ—ñ—à–∫–∏.
    const positions = [
        {x:20,y:430},{x:120,y:430},{x:220,y:430},{x:320,y:430},{x:420,y:430},
        {x:520,y:430},{x:620,y:430},{x:720,y:430},{x:820,y:430},{x:820,y:330},
        {x:820,y:230},{x:720,y:230},{x:620,y:230},{x:520,y:230},{x:420,y:230},
        {x:320,y:230},{x:220,y:230},{x:120,y:230},{x:20,y:230},{x:20,y:130},
        {x:20,y:30},{x:120,y:30},{x:220,y:30},{x:320,y:30},{x:420,y:30},
        {x:520,y:30},{x:620,y:30},{x:720,y:30},{x:820,y:30},{x:920,y:30},
    ];

    let positionIndex = 0;
    let isMoving = false;

    // --- 4. –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∑ –±–∞–∑–∏ (–í–ö–õ–Æ–ß–ê–Ñ –í–°–Ü–• –ì–†–ê–í–¶–Ü–í) ---
    async function fetchBoardState() {
        try {
            const res = await fetch(`/game/${roomCode}/state/`);
            if (!res.ok) throw new Error(`–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞–Ω—É: ${res.status}`);
            const data = await res.json();

            // –û–Ω–æ–≤–ª—é—î–º–æ —Ñ—ñ—à–∫–∏ –í–°–Ü–• –≥—Ä–∞–≤—Ü—ñ–≤
            data.players_state.forEach(p => {
                const pEl = document.getElementById(`player-${p.uuid}`);
                if (pEl) {
                    const pos = positions[p.position];
                    pEl.style.left = `${pos.x}px`;
                    pEl.style.top = `${pos.y}px`;
                }

                // –Ø–∫—â–æ —Ü–µ –ø–æ—Ç–æ—á–Ω–∏–π –≥—Ä–∞–≤–µ—Ü—å, –æ–Ω–æ–≤–ª—é—î–º–æ –π–æ–≥–æ –ø–æ–∑–∏—Ü—ñ—é –¥–ª—è –ª–æ–≥—ñ–∫–∏ –∫–∏–¥–∫–∞
                if (p.uuid === currentPlayerUuid) {
                     positionIndex = p.position; // –û–Ω–æ–≤–ª—é—î–º–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é –∑–º—ñ–Ω–Ω—É
                     // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫—É–±–∏–∫–∞ (–ª–∏—à–µ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è, —è–∫—â–æ —Ü–µ –π–æ–≥–æ —Ö—ñ–¥)
                     dice.src = `/static/images/dice${p.dice_value}.png`;
                }
            });


        } catch (err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –¥–æ—à–∫–∏:", err);
        }
    }

    // --- 5. –§—É–Ω–∫—Ü—ñ—è —Ä—É—Ö—É —Ñ—ñ—à–∫–∏ (–ü–æ–∫—Ä–æ–∫–æ–≤–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è) ---
    async function movePlayer(steps) {
        if (isMoving) return;
        isMoving = true;
        rollButton.disabled = true; // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É –ø—ñ–¥ —á–∞—Å —Ä—É—Ö—É

        let targetIndex = positionIndex + steps;
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤–∏—Ö—ñ–¥ –∑–∞ –º–µ–∂—ñ –¥–æ—à–∫–∏
        if (targetIndex >= positions.length) {
            targetIndex = positions.length - 1;
            console.log("–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
        }

        const moveStep = async () => {
            if (positionIndex >= targetIndex) {
                isMoving = false;
                rollButton.disabled = false; // –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É

                // –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä—É—Ö—É –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –≤ –±–∞–∑—ñ
                await fetch(`/game/${roomCode}/update_position/`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
                    body: JSON.stringify({
                        player_uuid: currentPlayerUuid, // –ü–µ—Ä–µ–¥–∞—î–º–æ ID –≥—Ä–∞–≤—Ü—è
                        position: positionIndex
                    })
                });
                return;
            }
        const moveStep = async () => {
            if (positionIndex >= targetIndex) {
                isMoving = false;
                rollButton.disabled = false; // –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É


                await fetch(`/room/${roomCode}/`, { // –ó–º—ñ–Ω–µ–Ω–æ URL –Ω–∞ URL –∫—ñ–º–Ω–∞—Ç–∏
                    method: 'POST',
                    headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
                    body: JSON.stringify({
                        action: 'update_position', // <-- –ö–ª—é—á–æ–≤–µ –ø–æ–ª–µ –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥—ñ—ó
                        player_uuid: currentPlayerUuid,
                        position: positionIndex // –ü–æ–∑–∏—Ü—ñ—è, –Ω–∞ —è–∫—ñ–π –≥—Ä–∞–≤–µ—Ü—å –∑—É–ø–∏–Ω–∏–≤—Å—è
                    })
                });
                return;
            }
    // ... (–ª–æ–≥—ñ–∫–∞ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è —Ä—É—Ö—É) ...
};

            positionIndex++; // –ó–±—ñ–ª—å—à—É—î–º–æ –ø–æ–∑–∏—Ü—ñ—é
            const pos = positions[positionIndex];
            playerToken.style.left = `${pos.x}px`;
            playerToken.style.top = `${pos.y}px`;

            setTimeout(moveStep, 600); // –Ü–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ –∫—Ä–æ–∫–∞–º–∏
        };

        moveStep(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ä—É—Ö
    }

    // --- 6. –§—É–Ω–∫—Ü—ñ—è –∫–∏–¥–∫–∞ –∫—É–±–∏–∫–∞ ---
    async function rollDice() {
        if (isMoving) return;

        const finalResult = Math.floor(Math.random() * 6) + 1;
        let count = 0;
        let intervalTime = 50;
        const maxSpins = 20;
        rollButton.disabled = true; // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞ —á–∞—Å –∞–Ω—ñ–º–∞—Ü—ñ—ó

        const spinDice = () => {
            const randomFace = Math.floor(Math.random() * 6) + 1;
            dice.src = `/static/images/dice${randomFace}.png`;
            dice.style.transform = `rotate(${Math.random()*360}deg)`;

            count++;
            if (count < maxSpins) {
                intervalTime += 15;
                setTimeout(spinDice, intervalTime);
            } else {
                setTimeout(async () => {
                    // –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    dice.src = `/static/images/dice${finalResult}.png`;
                    dice.style.transform = "rotate(0deg)";

                    const url = `/game/${roomCode}/${currentPlayerUuid}/`; // <-- –ü—Ä–∏–∫–ª–∞–¥ URL, —è–∫—â–æ view –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î player_uuid

                    await fetch(url, { // ...
                        method: 'POST',
                        headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
                        body: JSON.stringify({
                            dice: finalResult
                        })
                    });

                    // –ü–æ—á–∏–Ω–∞—î–º–æ —Ä—É—Ö
                    movePlayer(finalResult);
                }, intervalTime);
            }
        };

        spinDice();
    }



    // --- 7. –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤ —ñ —á–∞—Ç—É ---
    async function updateRoomInfo() {
        try {
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –≥—Ä–∞–≤—Ü—ñ–≤
            const playersRes = await fetch(`${window.location.href}?ajax=players`);
            const playersData = await playersRes.json();
            playersList.innerHTML = playersData.players.map(p => `<li>${p.name}</li>`).join('');

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Ç—É
            const messagesRes = await fetch(`${window.location.href}?ajax=messages`);
            const messagesData = await messagesRes.json();

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —á–∞—Ç –±—É–≤ –Ω–∞ —Å–∞–º–æ–º—É –Ω–∏–∑—É –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º
            const isScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 1;

            chatBox.innerHTML = messagesData.messages.map(m =>
                `<div class="message">
                    <strong>${m.player}</strong>: ${m.content}
                    <div style="font-size:0.8em;color:gray">${m.timestamp}</div>
                </div>`).join('');

            // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –≤–Ω–∏–∑, –ª–∏—à–µ —è–∫—â–æ —á–∞—Ç –±—É–≤ –ø—Ä–æ–∫—Ä—É—á–µ–Ω–∏–π –≤–Ω–∏–∑ –¥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
            if (isScrolledToBottom) {
                 chatBox.scrollTop = chatBox.scrollHeight;
            }
        } catch(err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∫—ñ–º–Ω–∞—Ç–∏:", err);
        }
    }

    // --- 8. –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å ---
    form.addEventListener('submit', e => {
        e.preventDefault();

        // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ formData –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ –¥–∞–Ω–∏—Ö
        const formData = new FormData(form);

        // –î–æ–¥–∞—î–º–æ CSRF —Ç–æ–∫–µ–Ω –¥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        fetch(window.location.href, {
            method:'POST',
            body:formData,
            headers:{'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken} // –î–æ–¥–∞–Ω–æ CSRF
        }).then(res => {
            if (res.ok) return res.json();
            throw new Error(`–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: ${res.status}`);
        })
        .then(data => {
            if(data.status==='ok'){
                textarea.value=''; // –û—á–∏—â–∞—î–º–æ –ø–æ–ª–µ
                updateRoomInfo(); // –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Ç
            } else {
                console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ –±–µ–∫–µ–Ω–¥—É:", data.status);
            }
        })
        .catch(err=>console.error(err));
    });

    // --- 9. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞ –Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ ---

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –¥–æ—à–∫–∏ (–≤—Å—ñ—Ö —Ñ—ñ—à–æ–∫) –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
    setInterval(fetchBoardState, 2000);

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤ —Ç–∞ —á–∞—Ç—É –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
    setInterval(updateRoomInfo, 3000);

    // –ü–µ—Ä—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É
    fetchBoardState();
    updateRoomInfo();
});

</script>

{% endblock %}
