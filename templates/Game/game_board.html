{% extends 'base.html' %}

{% block title %}FunBoard{% endblock %}
{% load static %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç –∫—ñ–º–Ω–∞—Ç–∏ {{ room.code }}</title>
    <style>
        /* --- –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –≥—Ä–∏ --- */
        .game_board {
            border-collapse: collapse;
            margin: 20px auto;
        }
        .game_board td {
            width: 50px;
            height: 50px;
            border: 1px solid #333;
            text-align: center;
            vertical-align: middle;
            background-color: #f0f0f0;
            cursor: pointer;
        }
.game_board {
    width: 90vw;
    height: 90vh;
    border: 3px dashed #333;  /* –∫–æ–Ω—Ç—É—Ä –ø–æ–ª—è */
    position: relative;        /* —â–æ–± –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ –ø–æ–∑–∏—Ü—ñ—é–≤–∞—Ç–∏ */
    margin: 20px auto;
    background-color: #f0f0f0;
}

/* –ö–≤–∞–¥—Ä–∞—Ç–∏–∫–∏, —è–∫—ñ –ø–æ–∑–Ω–∞—á–∞—é—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤ */
.start {
    width: 30px;
    height: 30px;
    background-color: white;
    border: 2px solid black;
    position: absolute;        /* –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–∞–≤–∏—Ç–∏ —Ö–∞–æ—Ç–∏—á–Ω–æ */
    border-radius: 5px;        /* –∫–≤–∞–¥—Ä–∞—Ç –∑ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—è–º –∫—É—Ç—ñ–≤ */
}
.nm_ps {
    width: 30px;
    height: 30px;
    background-color: white;
    border: 2px solid black;
    position: absolute;        /* –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–∞–≤–∏—Ç–∏ —Ö–∞–æ—Ç–∏—á–Ω–æ */
    border-radius: 5px;        /* –∫–≤–∞–¥—Ä–∞—Ç –∑ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—è–º –∫—É—Ç—ñ–≤ */
}

/* --- –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –≥—Ä–∏ --- */
        .game_board {
            border-collapse: collapse;
            margin: 20px auto;
        }
        .game_board td {
            width: 50px;
            height: 50px;
            border: 1px solid #333;
            text-align: center;
            vertical-align: middle;
            background-color: #f0f0f0;
            cursor: pointer;
        }

        /* --- –°—Ç–∏–ª—ñ –¥–ª—è —á–∞—Ç—É --- */
        #chat-box {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: scroll;
            padding: 5px;
            background-color: #fafafa;
            margin-bottom: 10px;
        }

        #message-form textarea {
            width: 100%;
            height: 50px;
            margin-bottom: 5px;
        }
        #message-form button {
            padding: 5px 10px;
        }

        /* --- –°—Ç–∏–ª—ñ –¥–ª—è —Å–ø–∏—Å–∫—É –≥—Ä–∞–≤—Ü—ñ–≤ --- */
        #players-list {
            list-style: none;
            padding-left: 0;
        }
        #players-list li {
            padding: 2px 0;
        }
#board {
  position: relative;
  width: 600px;
  height: 400px;
  margin: 100px auto;
  background: url("{% static 'images/map.png' %}") no-repeat center center;
  background-size: cover;
  border: 2px solid #333;
  border-radius: 10px;
}

#player {
  position: absolute;
  width: 40px;
  height: 40px;
  background: red;
  border-radius: 50%;
  transition: all 0.8s ease; /* –ø–ª–∞–≤–Ω–∏–π —Ä—É—Ö */
  left: 0;
  top: 0;
}

#dice-wrapper {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 999999;
}

#dice {
  width: 80px;
  height: 80px;
  margin-bottom: 10px;
  transition: transform 0.3s ease;
}

#rollButton {
  background: #ffcc00;
  color: #222;
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

#rollButton:hover {
  background: #ffaa00;
  transform: scale(1.05);
}


    </style>
</head>
<div class="game_board">
    <div class="start" style="top: 430px; left: 20px;"></div>

    <div class="nm_ps" style="top: 430px; left: 20px;"><a>1</a></div>
    <div class="nm_ps" style="top: 430px; left: 120px;"><a>2</a></div>
    <div class="nm_ps" style="top: 430px; left: 220px;"><a>3</a></div>
    <div class="nm_ps" style="top: 430px; left: 320px;"><a>4</a></div>
    <div class="nm_ps" style="top: 430px; left: 420px;"><a>5</a></div>
    <div class="nm_ps" style="top: 430px; left: 520px;"><a>6</a></div>
    <div class="nm_ps" style="top: 430px; left: 620px;"><a>7</a></div>
    <div class="nm_ps" style="top: 430px; left: 720px;"><a>8</a></div>
    <div class="nm_ps" style="top: 430px; left: 820px;"><a>9</a></div>

    <div class="nm_ps" style="top: 330px; left: 820px;"><a>10</a></div>

    <div class="nm_ps" style="top: 230px; left: 820px;"><a>11</a></div>
    <div class="nm_ps" style="top: 230px; left: 720px;"><a>12</a></div>
    <div class="nm_ps" style="top: 230px; left: 620px;"><a>13</a></div>
    <div class="nm_ps" style="top: 230px; left: 520px;"><a>14</a></div>
    <div class="nm_ps" style="top: 230px; left: 420px;"><a>15</a></div>
    <div class="nm_ps" style="top: 230px; left: 320px;"><a>16</a></div>
    <div class="nm_ps" style="top: 230px; left: 220px;"><a>17</a></div>
    <div class="nm_ps" style="top: 230px; left: 120px;"><a>18</a></div>
    <div class="nm_ps" style="top: 230px; left: 20px;"><a>19</a></div>

    <div class="nm_ps" style="top: 130px; left: 20px;"><a>20</a></div>

    <div class="nm_ps" style="top: 30px; left: 20px;"><a>21</a></div>
    <div class="nm_ps" style="top: 30px; left: 120px;"><a>22</a></div>
    <div class="nm_ps" style="top: 30px; left: 220px;"><a>23</a></div>
    <div class="nm_ps" style="top: 30px; left: 320px;"><a>24</a></div>
    <div class="nm_ps" style="top: 30px; left: 420px;"><a>25</a></div>
    <div class="nm_ps" style="top: 30px; left: 520px;"><a>26</a></div>
    <div class="nm_ps" style="top: 30px; left: 620px;"><a>27</a></div>
    <div class="nm_ps" style="top: 30px; left: 720px;"><a>28</a></div>
    <div class="nm_ps" style="top: 30px; left: 820px;"><a>29</a></div>

    <div class="nm_ps" style="top: 30px; left: 920px;"><a>30</a></div>

    <div id="player"></div>
</div>


<div id="dice-wrapper">
  <img id="dice" src="{% static 'images/dice1.png' %}" alt="Dice">
  <button id="rollButton" onclick="rollDice()">üé≤</button>
</div>



<h1>–ö—ñ–º–Ω–∞—Ç–∞ {{ room.code }}</h1>

<h3>–ì—Ä–∞–≤—Ü—ñ:</h3>
<ul id="players-list">
    {% for player in players %}
        <li>{{ player.name }}</li>
    {% endfor %}
</ul>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const dice = document.getElementById("dice");
    const rollButton = document.getElementById("rollButton");
    const player = document.getElementById("player");
    const chatBox = document.getElementById('chat-box');
    const playersList = document.getElementById('players-list');
    const form = document.getElementById('message-form');
    const textarea = document.getElementById('messageInput');

    if (!dice || !rollButton || !player) return;

    // –ú–∞—Å–∏–≤ –ø–æ–∑–∏—Ü—ñ–π —Ñ—ñ—à–∫–∏
    const positions = [
        {x:20,y:430},{x:120,y:430},{x:220,y:430},{x:320,y:430},{x:420,y:430},
        {x:520,y:430},{x:620,y:430},{x:720,y:430},{x:820,y:430},{x:820,y:330},
        {x:820,y:230},{x:720,y:230},{x:620,y:230},{x:520,y:230},{x:420,y:230},
        {x:320,y:230},{x:220,y:230},{x:120,y:230},{x:20,y:230},{x:20,y:130},
        {x:20,y:30},{x:120,y:30},{x:220,y:30},{x:320,y:30},{x:420,y:30},
        {x:520,y:30},{x:620,y:30},{x:720,y:30},{x:820,y:30},{x:920,y:30},
    ];

    let positionIndex = 0;
    let isMoving = false;

    // –§—É–Ω–∫—Ü—ñ—è —Ä—É—Ö—É —Ñ—ñ—à–∫–∏
    function movePlayer(steps) {
        isMoving = true;
        let targetIndex = positionIndex + steps;
        if (targetIndex >= positions.length) targetIndex = positions.length - 1;

        const moveStep = () => {
            if (positionIndex >= targetIndex) {
                isMoving = false;
                return;
            }
            positionIndex++;
            const pos = positions[positionIndex];
            player.style.left = `${pos.x}px`;
            player.style.top = `${pos.y}px`;

            setTimeout(moveStep, 600);
        };

        moveStep();
    }

    // –§—É–Ω–∫—Ü—ñ—è –∫–∏–¥–∫–∞ –∫—É–±–∏–∫–∞
    function rollDice() {
        if (isMoving) return;

        const finalResult = Math.floor(Math.random() * 6) + 1;
        let count = 0;
        let intervalTime = 50;
        const maxSpins = 20;

        const spinDice = () => {
            const randomFace = Math.floor(Math.random() * 6) + 1;
            dice.src = `/static/images/dice${randomFace}.png`;
            dice.style.transform = `rotate(${Math.random()*360}deg)`;

            count++;
            if (count < maxSpins) {
                intervalTime += 15;
                setTimeout(spinDice, intervalTime);
            } else {
                setTimeout(() => {
                    dice.src = `/static/images/dice${finalResult}.png`;
                    dice.style.transform = "rotate(0deg)";
                    movePlayer(finalResult);
                }, intervalTime);
            }
        };

        spinDice();
    }

    // –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏
    rollButton.addEventListener('click', rollDice);

    // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤ —ñ —á–∞—Ç—É —á–µ—Ä–µ–∑ AJAX
    function updateRoom() {
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤
        const playersUrl = new URL(window.location.href);
        playersUrl.searchParams.set('ajax','players');
        fetch(playersUrl)
            .then(res => res.ok ? res.json() : Promise.reject(res.status))
            .then(data => {
                if (playersList) playersList.innerHTML = data.players.map(p => `<li>${p.name}</li>`).join('');
            })
            .catch(err => console.log('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤:', err));

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Ç—É
        const messagesUrl = new URL(window.location.href);
        messagesUrl.searchParams.set('ajax','messages');
        fetch(messagesUrl)
            .then(res => res.ok ? res.json() : Promise.reject(res.status))
            .then(data => {
                if (chatBox) {
                    chatBox.innerHTML = data.messages.map(m =>
                        `<div class="message">
                            <strong>${m.player}</strong>: ${m.content}
                            <div style="font-size:0.8em;color:gray">${m.timestamp}</div>
                        </div>`
                    ).join('');
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            })
            .catch(err => console.log('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:', err));
    }

    setInterval(updateRoom, 3000);

    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    if (form && textarea) {
        form.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(form);
            fetch(window.location.href, {
                method:'POST',
                body:formData,
                headers:{'X-Requested-With':'XMLHttpRequest'}
            })
            .then(res => res.ok ? res.json() : Promise.reject(res.status))
            .then(data => {
                if (data.status === 'ok') {
                    textarea.value = '';
                    updateRoom();
                }
            })
            .catch(err => console.log('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', err));
        });
    }
});
</script>

{% endblock %}
